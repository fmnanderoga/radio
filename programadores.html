<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Notificaciones</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
    font-family: 'Nunito', sans-serif;
    background: #f5f5f5;
    padding: 15px;
}
h1 {
    text-align: center;
    margin-bottom: 20px;
    color: #0f8f5a;
    font-size: 1.6rem;
}
.card-container {
    max-width: 600px;
    margin: auto;
    width: 100%;
}
.card {
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    background: #fff;
}
textarea, input[type="number"] {
    border-radius: 8px;
    font-size: 1rem;
}
#contador, #programaContador {
    font-weight: bold;
    font-size: 1.1rem;
    margin-top: 15px;
    color: #0f8f5a;
    text-align: center;
}
#status, #programaStatus {
    text-align: center;
    margin-top: 10px;
    font-size: 1rem;
}
</style>
</head>
<body>

<h1>Panel de Notificaciones</h1>

<div class="card-container">
    <div class="card">
        <!-- Notificación normal -->
        <div class="mb-3">
            <label for="notificacionTexto" class="form-label">Texto de la notificación:</label>
            <textarea class="form-control" id="notificacionTexto" rows="3" placeholder="Escribe aquí tu mensaje..."></textarea>
        </div>

        <div class="mb-3">
            <label for="duracion" class="form-label">Duración (minutos):</label>
            <input type="number" id="duracion" class="form-control" min="1" value="10">
        </div>

        <div class="row g-2 mb-3">
            <div class="col-12 col-sm-6">
                <button id="guardarBtn" class="btn btn-success w-100">Guardar</button>
            </div>
            <div class="col-12 col-sm-6">
                <button id="borrarBtn" class="btn btn-danger w-100">Borrar</button>
            </div>
        </div>

        <div id="status" class="mt-3"></div>
        <div id="contador"></div>

        <!-- Nueva notificación de programa -->
        <hr>
        <div class="mb-3 mt-4">
            <label for="programaTexto" class="form-label">Texto de la notificación de programa:</label>
            <textarea class="form-control" id="programaTexto" rows="2">Programa comienza en:</textarea>
        </div>

        <div class="mb-3">
            <label for="programaDuracion" class="form-label">Duración del programa (minutos):</label>
            <input type="number" id="programaDuracion" class="form-control" min="1" value="10">
        </div>

        <div class="row g-2 mb-3">
            <div class="col-12 col-sm-6">
                <button id="guardarProgramaBtn" class="btn btn-primary w-100">Guardar Programa</button>
            </div>
            <div class="col-12 col-sm-6">
                <button id="borrarProgramaBtn" class="btn btn-secondary w-100">Borrar Programa</button>
            </div>
        </div>

        <div id="programaStatus" class="mt-2"></div>
        <div id="programaContador"></div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCGve3UBqB95lpKC19HQOyiUq7WjZg22IA",
    authDomain: "fm-nanderoga-e3e68.firebaseapp.com",
    databaseURL: "https://fm-nanderoga-e3e68-default-rtdb.firebaseio.com",
    projectId: "fm-nanderoga-e3e68",
    storageBucket: "fm-nanderoga-e3e68.firebasestorage.app",
    messagingSenderId: "888936894327",
    appId: "1:888936894327:web:5e2d8c7c20188dbf391b72",
    measurementId: "G-6QW100YFH7"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
</script>

<script>
// ===================== VARIABLES DOM =====================
const guardarBtn = document.getElementById('guardarBtn');
const borrarBtn = document.getElementById('borrarBtn');
const notificacionTexto = document.getElementById('notificacionTexto');
const duracionInput = document.getElementById('duracion');
const statusEl = document.getElementById('status');
const contadorEl = document.getElementById('contador');

let intervalId = null;

// ===================== NOTIFICACIÓN NORMAL =====================
database.ref('notificacionActual').on('value', snapshot => {
    const data = snapshot.val();
    if(data && data.texto){
        notificacionTexto.value = data.texto;
        if(data.expiraEn){
            iniciarCuentaAtras(data.expiraEn);
        }
    } else {
        notificacionTexto.value = "";
        contadorEl.textContent = "";
    }
});

function borrarNotificacion() {
    database.ref('notificacionActual').set(null);
    statusEl.textContent = "Notificación borrada";
    statusEl.className = "mt-3 text-warning";
    contadorEl.textContent = "";
    if(intervalId) clearInterval(intervalId);
}

function iniciarCuentaAtras(timestamp) {
    if(intervalId) clearInterval(intervalId);
    intervalId = setInterval(() => {
        const ahora = Date.now();
        const restante = Math.floor((timestamp - ahora) / 1000);
        if(restante <= 0){
            clearInterval(intervalId);
            borrarNotificacion();
            return;
        }
        const m = Math.floor(restante / 60);
        const s = ('0' + (restante % 60)).slice(-2);
        contadorEl.textContent = `Tiempo restante: ${m}:${s}`;
    }, 1000);
}

guardarBtn.addEventListener('click', () => {
    const texto = notificacionTexto.value.trim();
    const minutos = parseInt(duracionInput.value);
    if(!texto || !minutos) return;

    const expiraEn = Date.now() + minutos * 60 * 1000;

    database.ref('notificacionActual').set({
        texto: texto,
        expiraEn: expiraEn
    })
    .then(() => {
        statusEl.textContent = "Notificación guardada";
        statusEl.className = "mt-3 text-success";
        iniciarCuentaAtras(expiraEn);
    })
    .catch(err => {
        statusEl.textContent = "Error al guardar: " + err;
        statusEl.className = "mt-3 text-danger";
    });
});

borrarBtn.addEventListener('click', borrarNotificacion);

// ===================== NOTIFICACIÓN DE PROGRAMA =====================
const programaTextoInput = document.getElementById('programaTexto');
const programaDuracionInput = document.getElementById('programaDuracion');
const guardarProgramaBtn = document.getElementById('guardarProgramaBtn');
const borrarProgramaBtn = document.getElementById('borrarProgramaBtn');
const programaStatusEl = document.getElementById('programaStatus');
const programaContadorEl = document.getElementById('programaContador');

let programaIntervalId = null;

// Leer notificación de programa al cargar
database.ref('notificacionPrograma').on('value', snapshot => {
    const data = snapshot.val();
    if(data && data.texto && data.expiraEn){
        programaTextoInput.value = data.texto;
        iniciarCuentaAtrasPrograma(data.expiraEn);
    } else {
        programaContadorEl.textContent = "";
        programaTextoInput.value = "Programa comienza en:";
    }
});

function borrarNotificacionPrograma() {
    database.ref('notificacionPrograma').set(null);
    programaStatusEl.textContent = "Notificación de programa borrada";
    programaStatusEl.className = "mt-2 text-warning";
    programaContadorEl.textContent = "";
    if(programaIntervalId) clearInterval(programaIntervalId);
}

function iniciarCuentaAtrasPrograma(timestamp) {
    if(programaIntervalId) clearInterval(programaIntervalId);
    programaIntervalId = setInterval(() => {
        const ahora = Date.now();
        const restante = Math.floor((timestamp - ahora) / 1000);
        if(restante <= 0){
            clearInterval(programaIntervalId);
            borrarNotificacionPrograma();
            return;
        }
        const m = Math.floor(restante / 60);
        const s = ('0' + (restante % 60)).slice(-2);
        programaContadorEl.textContent = `${programaTextoInput.value} ${m}:${s}`;
    }, 1000);
}

guardarProgramaBtn.addEventListener('click', () => {
    const texto = programaTextoInput.value.trim() || "Programa comienza en:";
    const minutos = parseInt(programaDuracionInput.value);
    if(!minutos) return;

    const expiraEn = Date.now() + minutos * 60 * 1000;

    database.ref('notificacionPrograma').set({
        texto: texto,
        expiraEn: expiraEn
    })
    .then(() => {
        programaStatusEl.textContent = "Notificación de programa guardada";
        programaStatusEl.className = "mt-2 text-success";
        iniciarCuentaAtrasPrograma(expiraEn);
    })
    .catch(err => {
        programaStatusEl.textContent = "Error al guardar: " + err;
        programaStatusEl.className = "mt-2 text-danger";
    });
});

borrarProgramaBtn.addEventListener('click', borrarNotificacionPrograma);
</script>

</body>
</html>
